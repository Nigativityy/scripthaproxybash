<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Monitoring Results</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      color: #fff;
      font-size: 18px;
      background-color: #11181d;
      height: 100%;
      text-align: center;
      padding: 0;
    }
    .card {
      border: 2px solid #20272e;
      background-color: #262d34;
      width: 33%;
      padding: 24px;
      text-align: center;
      margin: 0 auto;
    }
    table { color: #fff !important; }
    #abuseTable thead { font-weight: bold; }
    #abuseTable tbody tr {
        background-color: #5c1a1a;
        border-bottom: 2px solid #11181d;
    }
    #abuseTable tbody tr:hover { background-color: #7d2a2a; }
    canvas { margin-inline: auto; display: inline-block; }

    .modal-body .log-item {
        font-family: monospace;
        background-color: #11181d;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        text-align: left;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    .log-item .log-timestamp {
        color: #64B5F6; /* Light Blue */
        font-weight: bold;
    }
    /* MODIFICATION: Added style for the port number */
    .log-item .log-port {
        color: #FFD54F; /* Yellow */
    }
    .log-item .log-detail {
        color: #E0E0E0;
    }
    .log-item .log-detail strong {
        color: #81C784; /* Green */
    }
  </style>
</head>

<body>
  <div class="container-fluid" data-bs-theme="dark">
    <h2>Webmail access - Last Run: <span id="lastRun"></span></h2>
    <div class="row">
      <div class="card col-lg-3">
        <h2>Private IPs</h2>
        <canvas id="privatePieChart" width="400" height="400"></canvas>
        <h4 class="mt-3">Total Hits: <span id="privateTotalHits" class="badge badge-light">0</span></h4>
        <table id="privateTable" class="table table-sm table-striped"><thead><tr><th>IP Address</th><th>Count</th></tr></thead><tbody class="table-group-divider"></tbody></table>
      </div>
      <div class="card col-lg-6">
        <h2>Public IPs</h2>
        <canvas id="publicPieChart" width="400" height="400"></canvas>
        <h4 class="mt-3">Total Hits: <span id="publicTotalHits" class="badge badge-light">0</span></h4>
        <table id="publicTable" class="table table-sm table-striped"><thead><tr><th>IP Address</th><th>Count</th><th>Details</th></tr></thead><tbody class="table-group-divider"></tbody></table>
      </div>
      <div class="card col-lg-3">
        <h2>Abuse IPs</h2>
        <canvas id="abusePieChart" width="400" height="400"></canvas>
        <h4 class="mt-3">Total Hits: <span id="abuseTotalHits" class="badge badge-danger">0</span></h4>
        <table id="abuseTable" class="table table-borderless table-sm">
          <thead><tr><th>IP Address</th><th>Count</th><th>Score</th><th>Reports</th><th>Logs</th></tr></thead>
          <tbody class="table-group-divider"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="logModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="background-color: #262d34;"><div class="modal-header"><h5 class="modal-title" id="logModalLabel">Logs for IP</h5><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true" style="color: #fff;">&times;</span></button></div><div class="modal-body" id="logModalBody"></div></div></div></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let charts = {};
    
    function createPieChart(canvasId, chartData) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (charts[canvasId]) { charts[canvasId].destroy(); }
      charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: chartData.map(item => item.ip),
          datasets: [{ data: chartData.map(item => item.count), backgroundColor: ['#E57373','#64B5F6','#FFD54F','#4DB6AC','#BA68C8','#FF8A65','#F06292','#7986CB','#81C784','#FFCCBC','#90CAF9','#FF0000','#007BFF','#FFD700','#00FF7F','#8000FF','#FF4500','#FF1493','#483D8B','#32CD32','#FFA07A','#00CED1'], borderWidth: 0 }]
        },
        options: {
          responsive: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#fff', font: { size: 14 } }
            }
          }
        }
      });
    }

    async function getIpDetailsBatch(ips) {
      const response = await fetch(`http://ip-api.com/batch`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ips.map(ip => ({ query: ip, fields: "status,country,city,isp" }))) });
      const data = await response.json();
      return data.map(item => (item.status === "success") ? item : { country: "N/A", city: "N/A", isp: "N/A" });
    }

    function createTable(tableId, data) {
      data.sort((a, b) => b.count - a.count);
      const total = data.reduce((sum, item) => sum + item.count, 0);
      document.getElementById('privateTotalHits').textContent = total;
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
      });
    }

    async function createDetailedTable(tableId, data) {
      data.sort((a, b) => b.count - a.count);
      const total = data.reduce((sum, item) => sum + item.count, 0);
      document.getElementById('publicTotalHits').textContent = total;
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      const ipDetailsList = await getIpDetailsBatch(data.map(item => item.ip));
      data.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
        const ipDetails = ipDetailsList[index];
        row.insertCell(2).textContent = `${ipDetails.country} / ${ipDetails.city} / ${ipDetails.isp}`;
      });
    }
    
    function createAbuseTable(tableId, data) {
      data.sort((a, b) => b.count - a.count);
      const total = data.reduce((sum, item) => sum + item.count, 0);
      document.getElementById('abuseTotalHits').textContent = total;
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
        row.insertCell(2).textContent = item.score + '%';
        row.insertCell(3).textContent = item.reports;
        const actionCell = row.insertCell(4);
        const button = document.createElement('button');
        button.className = 'btn btn-danger btn-sm';
        button.textContent = 'View';
        button.addEventListener('click', () => {
          document.getElementById('logModalLabel').textContent = `Logs for ${item.ip}`;
          const modalBody = document.getElementById('logModalBody');
          modalBody.innerHTML = '';
          
          // MODIFICATION: Updated Regex to capture the source port
          const logRegex = /:(\d+)\s+\[(.*?)\]\s+http_frontend\s+http_servers\/(\w+)\s+[\d\/]+\/(\d+)\s+\d+\s+([A-Z-]{2})/;

          if (item.actions && item.actions.length > 0) {
            item.actions.forEach(logLine => {
              const match = logLine.match(logRegex);
              const logItem = document.createElement('div');
              logItem.className = 'log-item';

              if (match) {
                // MODIFICATION: Map the new captured groups
                const port = match[1];
                const timestamp = match[2];
                const backend = match[3];
                const duration = match[4];
                const termState = match[5] === '--' ? 'NORMAL' : match[5];

                // MODIFICATION: Add the port to the display
                logItem.innerHTML = `
                  <span class="log-timestamp">[${timestamp}]</span>
                  <span class="log-port">Port: <strong>${port}</strong></span>
                  <span class="log-detail"><strong>Backend:</strong> ${backend}</span>
                  <span class="log-detail"><strong>Duration:</strong> ${duration}ms</span>
                  <span class="log-detail"><strong>Status:</strong> ${termState}</span>
                `;
              } else {
                logItem.textContent = logLine;
              }
              modalBody.appendChild(logItem);
            });
          } else {
            modalBody.textContent = 'No detailed log entries found.';
          }
          $('#logModal').modal('show');
        });
        actionCell.appendChild(button);
      });
    }

    function updateChart(chartId, newData) {
      if (charts[chartId]) {
        newData.sort((a, b) => b.count - a.count);
        const chart = charts[chartId];
        chart.data.labels = newData.map(item => item.ip);
        chart.data.datasets[0].data = newData.map(item => item.count);
        chart.update();
      }
    }

    fetch('/results').then(r => r.json()).then(data => {
      document.getElementById('lastRun').textContent = data.last_run;
      createTable('privateTable', data.private_ips);
      createDetailedTable('publicTable', data.public_ips);
      createAbuseTable('abuseTable', data.abuse_ips);
      createPieChart('privatePieChart', data.private_ips);
      createPieChart('publicPieChart', data.public_ips);
      createPieChart('abusePieChart', data.abuse_ips);
    });

    const socket = io();
    socket.on('update', (data) => {
      const results = JSON.parse(data);
      document.getElementById('lastRun').textContent = results.last_run;
      createTable('privateTable', results.private_ips);
      createDetailedTable('publicTable', results.public_ips);
      createAbuseTable('abuseTable', results.abuse_ips);
      updateChart('privatePieChart', results.private_ips);
      updateChart('publicPieChart', results.public_ips);
      updateChart('abusePieChart', results.abuse_ips);
    });

    setInterval(() => { location.reload(); }, 300000);
  </script>
</body>
</html>
