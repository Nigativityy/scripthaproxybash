<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Monitoring Results</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // Global chart instances
    let charts = {};
  </script>
  <style>
    body {
      color: #fff;
      font-size: 18px;
      background-color: #11181d;
      height: 100%;
      text-align: center;
      padding: 0;
    }

    .card {
      border: 2px solid #20272e;
      background-color: #262d34;
      width: 33%;
      padding: 24px;
      text-align: center;
      margin: 0 auto;
    }

    table {
      color: #fff !important;
    }

    #abuseTable thead {
      font-weight: bold;
    }

    /* MODIFICATION: Added style for red background on abuse IP rows */
    #abuseTable tbody tr {
        background-color: #5c1a1a; /* A dark, readable red */
        border-bottom: 2px solid #11181d; /* Adds a separator between rows */
    }
    #abuseTable tbody tr:hover {
        background-color: #7d2a2a; /* Slightly lighter red on hover */
    }

    canvas {
      margin-inline: auto;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div class="container-fluid" data-bs-theme="dark">
    <h2>Webmail access - Last Run: <span id="lastRun"></span></h2>
    <div class="row">
      <div class="card col-lg-3">
        <h2>Private IPs</h2>
        <canvas id="privatePieChart" width="400" height="400"></canvas>
        <table id="privateTable" class="table table-sm table-striped">
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody class="table-group-divider"></tbody>
        </table>
      </div>
      <div class="card col-lg-6">
        <h2>Public IPs</h2>
        <canvas id="publicPieChart" width="400" height="400"></canvas>
        <table id="publicTable" class="table table-sm table-striped">
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Count</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody class="table-group-divider"></tbody>
        </table>
      </div>
      <div class="card col-lg-3">
        <h2>Abuse IPs</h2>
        <canvas id="abusePieChart" width="400" height="400"></canvas>
        <table id="abuseTable" class="table table-borderless table-sm">
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Count</th>
              <th>Abuse Score</th>
              <th>Reports (90d)</th>
            </tr>
          </thead>
          <tbody class="table-group-divider"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    // Function to create a doughnut chart and store its instance
    function createPieChart(canvasId, chartData) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = chartData.map(item => item.ip);
      const data = chartData.map(item => item.count);

      // Destroy existing chart if it exists to prevent duplicates
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }

      charts[canvasId] = new Chart(ctx, { // MODIFICATION: Store chart instance
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#E57373', '#64B5F6', '#FFD54F', '#4DB6AC', '#BA68C8', '#FF8A65',
              '#F06292', '#7986CB', '#81C784', '#FFCCBC', '#90CAF9',
              '#FF0000', '#007BFF', '#FFD700', '#00FF7F', '#8000FF', '#FF4500',
              '#FF1493', '#483D8B', '#32CD32', '#FFA07A', '#00CED1'
            ],
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#fff', font: { size: 14 } }
            },
            datalabels: {
              color: '#fff',
              formatter: (value) => `${value}`,
              display: true,
              align: 'center',
              anchor: 'center'
            }
          }
        }
      });
    }

    async function getIpDetailsBatch(ips) {
      const response = await fetch(`http://ip-api.com/batch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ips.map(ip => ({ query: ip, fields: "status,country,city,isp" })))
      });
      const data = await response.json();
      return data.map(item => (item.status === "success") ? item : { country: "N/A", city: "N/A", isp: "N/A" });
    }

    function createTable(tableId, data) {
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
      });
    }

    async function createDetailedTable(tableId, data) {
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      const ipList = data.map(item => item.ip);
      const ipDetailsList = await getIpDetailsBatch(ipList);
      data.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
        const ipDetails = ipDetailsList[index];
        row.insertCell(2).textContent = `${ipDetails.country} / ${ipDetails.city} / ${ipDetails.isp}`;
      });
    }

    function createAbuseTable(tableId, data) {
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = item.ip;
        row.insertCell(1).textContent = item.count;
        row.insertCell(2).textContent = item.score + '%';
        row.insertCell(3).textContent = item.reports;
      });
    }

    // Function to update chart data
    function updateChart(chartId, newData) {
      if (charts[chartId]) {
        const chart = charts[chartId];
        chart.data.labels = newData.map(item => item.ip);
        chart.data.datasets[0].data = newData.map(item => item.count);
        chart.update();
      }
    }

    // Initial load of results when the page loads
    fetch('/results')
      .then(response => response.json())
      .then(data => {
        document.getElementById('lastRun').textContent = data.last_run;

        // MODIFICATION: Create all tables and charts on initial load
        createTable('privateTable', data.private_ips);
        createDetailedTable('publicTable', data.public_ips);
        createAbuseTable('abuseTable', data.abuse_ips);

        createPieChart('privatePieChart', data.private_ips);
        createPieChart('publicPieChart', data.public_ips);
        createPieChart('abusePieChart', data.abuse_ips);
      });

    const socket = io();
    socket.on('update', (data) => {
      const results = JSON.parse(data);
      document.getElementById('lastRun').textContent = results.last_run;

      // MODIFICATION: Update tables and charts on new data
      createTable('privateTable', results.private_ips);
      createDetailedTable('publicTable', results.public_ips);
      createAbuseTable('abuseTable', results.abuse_ips);

      updateChart('privatePieChart', results.private_ips);
      updateChart('publicPieChart', results.public_ips);
      updateChart('abusePieChart', results.abuse_ips);
    });

    // Reload the page every 5 minutes (300000 ms)
    setInterval(() => {
        location.reload();
    }, 300000);
  </script>

</body>
</html>
